<p-dialog
  [visible]="bookingDialogVisible()"
  (visibleChange)="onHide($event)"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full max-w-4xl"
>
  <ng-template pTemplate="header">
    <h2 class="text-2xl font-bold">
      <span class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
        {{ 'booking.form.title' | transloco }}
      </span>
    </h2>
  </ng-template>

  @if (error()) {
  <div
    class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <p class="text-red-600 text-sm">{{ error() }}</p>
  </div>
  } @if (clientStore.loading() || serviceStore.loading()) {
  <div class="flex justify-center items-center py-8" role="status" aria-live="polite">
    <i class="pi pi-spin pi-spinner text-4xl text-indigo-600" aria-hidden="true"></i>
    <span class="sr-only">{{ 'common.loading' | transloco }}</span>
  </div>
  } @if (!clientStore.loading() && !serviceStore.loading()) {
  <div class="flex flex-col gap-4 py-4" [formGroup]="bookingForm">
    <!-- Client Selection -->
    <div class="flex flex-col gap-2">
      <label for="clientId" class="text-sm font-semibold text-gray-700">
        {{ 'booking.form.client' | transloco }}
        <span class="text-red-500" aria-hidden="true">*</span>
      </label>
      <div class="flex gap-2">
        <p-select
          id="clientId"
          formControlName="clientId"
          [options]="clientOptions()"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'booking.form.selectClient' | transloco"
          [filter]="true"
          [showClear]="true"
          class="flex-1"
          [attr.aria-invalid]="
            bookingForm.controls.clientId.invalid &&
            bookingForm.controls.clientId.touched &&
            bookingForm.controls.clientId.dirty
          "
          [attr.aria-describedby]="
            bookingForm.controls.clientId.invalid &&
            bookingForm.controls.clientId.touched &&
            bookingForm.controls.clientId.dirty
              ? 'clientId-error'
              : null
          "
        />
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          [label]="'booking.form.addClient' | transloco"
          severity="secondary"
          [outlined]="true"
          (click)="clientDialogVisible.set(true)"
          [attr.aria-label]="'booking.form.addClient' | transloco"
        ></button>
      </div>
      @if (bookingForm.controls.clientId.invalid && bookingForm.controls.clientId.touched &&
      bookingForm.controls.clientId.dirty) {
      <p-message id="clientId-error" severity="error" variant="simple" role="alert">
        {{ 'booking.form.clientRequired' | transloco }}
      </p-message>
      } @if (clientStore.clients().length === 0) {
      <small class="text-amber-600">
        {{ 'booking.form.noClientsAvailable' | transloco }}
      </small>
      }
    </div>

    <!-- Subject Selection -->
    <div class="flex flex-col gap-2">
      <label for="subjectId" class="text-sm font-semibold text-gray-700">
        {{ 'booking.form.subject' | transloco }}
        <span class="text-red-500" aria-hidden="true">*</span>
      </label>
      <div class="flex gap-2">
        <p-select
          id="subjectId"
          formControlName="subjectId"
          [options]="subjectOptions()"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'booking.form.selectSubject' | transloco"
          [disabled]="bookingForm.controls.clientId.invalid"
          [showClear]="true"
          class="flex-1"
          [attr.aria-invalid]="
            bookingForm.controls.subjectId.invalid &&
            bookingForm.controls.subjectId.touched &&
            bookingForm.controls.subjectId.dirty
          "
          [attr.aria-describedby]="
            bookingForm.controls.subjectId.invalid &&
            bookingForm.controls.subjectId.touched &&
            bookingForm.controls.subjectId.dirty
              ? 'subjectId-error'
              : null
          "
        />
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          [label]="'booking.form.addSubject' | transloco"
          severity="secondary"
          [outlined]="true"
          [disabled]="isAddSubjectDisabled()"
          (click)="subjectDialogVisible.set(true)"
          [attr.aria-label]="'booking.form.addSubject' | transloco"
        ></button>
      </div>
      @if (bookingForm.controls.subjectId.invalid && bookingForm.controls.subjectId.touched &&
      bookingForm.controls.subjectId.dirty) {
      <p-message id="subjectId-error" severity="error" variant="simple" role="alert">
        {{ 'booking.form.subjectRequired' | transloco }}
      </p-message>
      } @if (bookingForm.controls.clientId.value && subjectOptions().length === 0) {
      <small class="text-amber-600">
        {{ 'booking.form.noSubjectsAvailable' | transloco }}
      </small>
      }
    </div>

    <!-- Service Selection -->
    <div class="flex flex-col gap-2">
      <label for="serviceId" class="text-sm font-semibold text-gray-700">
        {{ 'booking.form.service' | transloco }}
        <span class="text-red-500" aria-hidden="true">*</span>
      </label>
      <div class="flex gap-2">
        <p-select
          id="serviceId"
          formControlName="serviceId"
          [options]="serviceOptions()"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'booking.form.selectService' | transloco"
          [disabled]="isServiceSelectDisabled()"
          [showClear]="true"
          class="flex-1"
          [attr.aria-invalid]="
            bookingForm.controls.serviceId.invalid &&
            bookingForm.controls.serviceId.touched &&
            bookingForm.controls.serviceId.dirty
          "
          [attr.aria-describedby]="
            bookingForm.controls.serviceId.invalid &&
            bookingForm.controls.serviceId.touched &&
            bookingForm.controls.serviceId.dirty
              ? 'serviceId-error'
              : null
          "
        />
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          [label]="'booking.form.addService' | transloco"
          severity="secondary"
          [outlined]="true"
          [disabled]="isAddServiceDisabled()"
          (click)="serviceDialogVisible.set(true)"
          [attr.aria-label]="'booking.form.addService' | transloco"
        ></button>
      </div>
      @if (isServiceSelectDisabled()) {
      <small class="text-gray-500">
        {{ 'booking.form.selectSubjectFirst' | transloco }}
      </small>
      } @else if (serviceOptions().length === 0) {
      <small class="text-amber-600">
        {{ 'booking.form.noMatchingServices' | transloco }}
      </small>
      } @else if (bookingForm.controls.serviceId.invalid && bookingForm.controls.serviceId.touched &&
      bookingForm.controls.serviceId.dirty) {
      <p-message id="serviceId-error" severity="error" variant="simple" role="alert">
        {{ 'booking.form.serviceRequired' | transloco }}
      </p-message>
      }
    </div>

    <!-- Date Range -->
    <div class="flex flex-col gap-2">
      <label for="dateRange" class="text-sm font-semibold text-gray-700">
        {{ 'booking.form.dateRange' | transloco }}
        <span class="text-red-500" aria-hidden="true">*</span>
      </label>
      <p-datepicker
        fluid
        id="dateRange"
        formControlName="dateRange"
        selectionMode="range"
        iconDisplay="input"
        [showButtonBar]="true"
        [placeholder]="'booking.form.selectDateRange' | transloco"
        dateFormat="dd/mm/yy"
        class="w-full"
        appendTo="body"
        [attr.aria-invalid]="
          bookingForm.controls.dateRange.invalid &&
          bookingForm.controls.dateRange.touched &&
          bookingForm.controls.dateRange.dirty
        "
        [attr.aria-describedby]="
          bookingForm.controls.dateRange.invalid &&
          bookingForm.controls.dateRange.touched &&
          bookingForm.controls.dateRange.dirty
            ? 'dateRange-error'
            : null
        "
      />
      @if (bookingForm.controls.dateRange.invalid && bookingForm.controls.dateRange.touched &&
      bookingForm.controls.dateRange.dirty) {
      <p-message id="dateRange-error" severity="error" variant="simple" role="alert">
        {{ 'booking.form.dateRangeRequired' | transloco }}
      </p-message>
      }
    </div>

    <!-- Notes -->
    <div class="flex flex-col gap-2">
      <label for="notes" class="text-sm font-semibold text-gray-700">
        {{ 'booking.form.notes' | transloco }}
      </label>
      <textarea
        id="notes"
        formControlName="notes"
        pTextarea
        rows="4"
        [placeholder]="'booking.form.notesPlaceholder' | transloco"
        class="w-full"
      ></textarea>
    </div>
  </div>
  }

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-3">
      <app-action-button
        [route]="null"
        type="button"
        labelKey="common.cancel"
        variant="secondary"
        (click)="onHide(false)"
        [disabled]="loading()"
      />
      <app-action-button
        [route]="null"
        type="button"
        labelKey="booking.form.create"
        icon="pi-check"
        [loading]="loading()"
        (click)="onSave()"
      />
    </div>
  </ng-template>
</p-dialog>

<app-client-form-dialog
  [(clientDialogVisible)]="clientDialogVisible"
  (clientCreated)="onClientCreated($event)"
/>

<app-subject-form-dialog
  [(subjectDialogVisible)]="subjectDialogVisible"
  [clientId]="bookingForm.controls.clientId.value || undefined"
  (subjectSaved)="onSubjectCreated()"
  (subjectCreated)="onSubjectCreated()"
/>

<app-service-form-dialog
  [(serviceDialogVisible)]="serviceDialogVisible"
  [prefilledType]="serviceDialogPrefilledType()"
  (serviceCreated)="onServiceCreated($event)"
/>
